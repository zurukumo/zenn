---
title: "Ruby + Selenium + Chrome + Dockerã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°"
emoji: "ğŸŒˆ"
type: "tech"
topics:
  - "chrome"
  - "docker"
  - "ruby"
  - "selenium"
published: true
published_at: "2023-11-22 18:19"
---

## æ¦‚è¦
Ruby + Selenium + Chrome + Dockerã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã™ã‚‹æ–¹æ³•ã‚’æ¨¡ç´¢ã—ã¦ã„ãŸã¨ã“ã‚ä¸‹è¨˜ã®ã‚ˆã†ãªè¨˜äº‹ã«ãŸã©ã‚Šç€ã„ãŸã€‚
https://zenn.dev/ydammatsu/articles/49f1d8b68a920c
ã—ã‹ã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³115ä»¥é™ã®ChromeDriverã¯é…ç½®å…ˆãŒåˆ¥ã‚µãƒ¼ãƒãƒ¼ã«ç§»è¡Œã—ãŸã‚ˆã†ã§ã€ä¸Šè¨˜ã®è¨˜äº‹ã®æ‰‹æ³•ã¯ä½¿ç”¨ã§ããªããªã£ã¦ã„ãŸã€‚ãã“ã§æ–°ã‚µãƒ¼ãƒãƒ¼ã«å¯¾å¿œã—ãŸã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹æ‰‹æ³•ã‚’èª¿æŸ»ã—ãŸã€‚

## è¿½è¨˜(2024-02-20)
https://googlechromelabs.github.io/chrome-for-testing/ ã‚’ç¢ºèªã™ã‚‹ã¨ã€Chromeã¨ChromeDriverã®ä¿ç®¡å…ˆãŒå¤‰æ›´ã•ã‚ŒãŸæ§˜å­ã€‚
Dockerfileä¸­ã®`https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing`ã¨ãªã£ã¦ã„ã‚‹ç®‡æ‰€ã‚’ã€é©å®œ`https://storage.googleapis.com/chrome-for-testing-public`ã«å¤‰æ›´ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚

## èª¿æŸ»
ãƒãƒ¼ã‚¸ãƒ§ãƒ³115ä»¥é™ã®ChromeDriverã®é…ç½®å…ˆã¯ä»¥ä¸‹ã«ãªã£ã¦ã„ã‚‹ã€‚
https://googlechromelabs.github.io/chrome-for-testing/
ã¡ãªã¿ã«114ä»¥å‰ã¯ä»¥ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã€‚
https://chromedriver.chromium.org/downloads/version-selection
ã¾ãŸã€å®‰å®šç‰ˆã‚„ãƒ™ãƒ¼ã‚¿ç‰ˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—ã™ã‚‹APIã‚‚ä»¥ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã€‚
https://github.com/GoogleChromeLabs/chrome-for-testing#json-api-endpoints
Chromeã¨ChromeDriverã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è‡´ã•ã›ãªã„ã¨SeleniumãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„ãŸã‚ã€
1. å®‰å®šç‰ˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’APIã‹ã‚‰å–å¾—ã€‚
2. è©²å½“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Chromeã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚
3. è©²å½“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ChromeDriverã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚

ã¨ã„ã†æµã‚Œç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ãã€‚

## å®Ÿéš›ã®Dockerfile
```docker:Dockerfile
# ARMã‚’ä½¿ç”¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã§AMDã‚’ä½¿ç”¨
FROM --platform=linux/amd64 ruby:3.2.2

# å¤‰æ•°ã®è¨­å®š
ARG APP_ROOT="/app"
ARG CHROME_PACKAGES="libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2"
ARG CHROME_WEBDRIVER_PACKAGES="libnss3-dev"

# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt update -qq \
    && apt install -y ${CHROME_PACKAGES} \
    && apt install -y ${CHROME_WEBDRIVER_PACKAGES}

# Chrome & Chrome Driverã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN CHROME_VERSION=`curl -sS https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE` \
    && curl -sS -o /tmp/chrome-linux64.zip https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$CHROME_VERSION/linux64/chrome-linux64.zip \
    && unzip -d /tmp /tmp/chrome-linux64.zip \
    && mkdir -p /usr/local/lib/chrome \
    && mv /tmp/chrome-linux64/* /usr/local/lib/chrome \
    && ln -s /usr/local/lib/chrome/chrome /usr/local/bin/chrome \
    && curl -sS -o /tmp/chromedriver-linux64.zip https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$CHROME_VERSION/linux64/chromedriver-linux64.zip \
    && unzip -d /tmp /tmp/chromedriver-linux64.zip \
    && mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin

# Seleniumã®ã‚¹ã‚¯ã‚·ãƒ§ãŒæ–‡å­—åŒ–ã‘ã—ãªã„ã‚ˆã†ã«æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN curl -sS -o /tmp/NotoSansCJKjp-hinted.zip https://noto-website-2.storage.googleapis.com/pkgs/NotoSansCJKjp-hinted.zip \
    && unzip -d /tmp/NotoSansCJKjp-hinted /tmp/NotoSansCJKjp-hinted.zip \
    && mkdir -p /usr/share/fonts/noto \
    && cp /tmp/NotoSansCJKjp-hinted/*.otf /usr/share/fonts/noto/ \
    && chmod 644 /usr/share/fonts/noto/*.otf \
    && fc-cache -fv

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨ã‚³ãƒ”ãƒ¼
WORKDIR $APP_ROOT
COPY . ${APP_ROOT}/

# Gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN bundle install -j4 \
    && bundle clean --force

# ãŠæƒé™¤
RUN rm -rf /tmp/*

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
CMD ["rails", "server", "-b", "0.0.0.0"]
```

## é›‘è§£èª¬
```docker:Dockerfile
ARG CHROME_PACKAGES="libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2"
ARG CHROME_WEBDRIVER_PACKAGES="libnss3-dev"
```
ã§Chromeã‚„ChromeDriverãŒä¾å­˜ã—ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®æº–å‚™ã‚’ã—ã¦ã„ã‚‹ã€‚
ã“ã‚Œã‚‰ã¯åœ°é“ã«èª¿ã¹ãŸã€‚Chromeã‚„ChromeDriverã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã¯å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§è¦æ³¨æ„ã€‚

æ¬¡ã«
```docker:Dockerfile
RUN CHROME_VERSION=`curl -sS https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE` \
    && curl -sS -o /tmp/chrome-linux64.zip https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$CHROME_VERSION/linux64/chrome-linux64.zip \
    && unzip -d /tmp /tmp/chrome-linux64.zip \
    && mkdir -p /usr/local/lib/chrome \
    && mv /tmp/chrome-linux64/* /usr/local/lib/chrome \
    && ln -s /usr/local/lib/chrome/chrome /usr/local/bin/chrome \
    && curl -sS -o /tmp/chromedriver-linux64.zip https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$CHROME_VERSION/linux64/chromedriver-linux64.zip \
    && unzip -d /tmp /tmp/chromedriver-linux64.zip \
    && mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin
```
ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã®æ„å‘³ã‚’ã–ã£ãã‚Šè§£èª¬ã™ã‚‹ã€‚

ã¾ãš1è¡Œç›®ã®
```docker:Dockerfile
RUN CHROME_VERSION=`curl -sS https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE` \
```
ã§å¤‰æ•°CHROME_VERSIONã«å®‰å®šç‰ˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ ¼ç´ã™ã‚‹ã€‚
ãã®æ¬¡ã®2~6è¡Œç›®ã®
```docker:Dockerfile
    && curl -sS -o /tmp/chrome-linux64.zip https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$CHROME_VERSION/linux64/chrome-linux64.zip \
    && unzip -d /tmp /tmp/chrome-linux64.zip \
    && mkdir -p /usr/local/lib/chrome \
    && mv /tmp/chrome-linux64/* /usr/local/lib/chrome \
    && ln -s /usr/local/lib/chrome/chrome /usr/local/bin/chrome \
```
ã§ã¯Chromeã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€7~9è¡Œç›®ã®
```docker:Dokcerfile
    && curl -sS -o /tmp/chromedriver-linux64.zip https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$CHROME_VERSION/linux64/chromedriver-linux64.zip \
    && unzip -d /tmp /tmp/chromedriver-linux64.zip \
    && mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin
```
ã§ã¯ChromeDriverã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã€‚

ChromeDriverã¯zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡ã™ã‚‹ã¨1ã¤ã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚‹ã®ã§ã€`/usr/local/bin`ã«ãã®ã¾ã¾ç§»å‹•ã—ã¦ã‚„ã‚Œã°ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ãŒã€Chromeã¯è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¾ã¨ã‚ã¦`/usr/local/lib`ã«ä¿å­˜ã—ã¦ã‚„ã‚Šã€ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã ã‘ã‚’`/user/local/bin`ã«ä½œæˆã™ã‚‹ã®ãŒãƒ™ã‚¿ãªã‚„ã‚Šæ–¹ã‚‰ã—ã„ã€‚
Linuxã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å½¹å‰²ãªã©ã‚’å…¨ãç†è§£ã§ãã¦ã„ãªã„ã®ã§å‹‰å¼·ã«ãªã£ãŸã€‚

## å‚è€ƒ
https://chromedriver.chromium.org/downloads/version-selection
https://googlechromelabs.github.io/chrome-for-testing/
https://github.com/GoogleChromeLabs/chrome-for-testing#json-api-endpoints
https://zenn.dev/ydammatsu/articles/49f1d8b68a920c
https://exworl.com/python-1/
https://qiita.com/sgash708/items/5040d16a231394016b19